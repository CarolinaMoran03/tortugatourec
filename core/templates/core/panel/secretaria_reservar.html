{% extends "core/base.html" %}
{% block title %}Reserva Asistida | TortugaTur{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
        <div class="flex items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tight">Reserva Asistida</h1>
                <p class="text-slate-500 text-sm">La secretaria busca tours y registra la reserva del cliente.</p>
            </div>
            <a href="{% url 'panel_admin' %}"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:text-primary hover:border-primary/30 transition-all font-bold text-sm shadow-sm">
                <span class="material-icons text-base">arrow_back</span>
                Panel
            </a>
        </div>

        <div id="filtrosReserva" class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
            <form method="get" class="grid md:grid-cols-4 gap-4 items-end">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em] mb-2">Destino</label>
                    <select name="destino" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-semibold">
                        <option value="">Selecciona destino</option>
                        {% for destino in destinos %}
                        <option value="{{ destino.id }}" {% if destino_id == destino.id|stringformat:"s" %}selected{% endif %}>{{ destino.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em] mb-2">Fecha</label>
                    <input type="date" name="fecha" value="{{ fecha_busqueda }}" required
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-semibold">
                </div>
                <button type="submit"
                    class="h-12 bg-slate-900 text-white rounded-xl font-black text-xs tracking-widest hover:bg-primary transition">
                    BUSCAR TOURS
                </button>
                <a href="{% url 'secretaria_reservar' %}"
                    class="h-12 inline-flex items-center justify-center rounded-xl bg-slate-100 text-slate-700 font-black text-xs tracking-widest hover:bg-slate-200 transition">
                    REFRESCAR
                </a>
            </form>
        </div>
        <p id="msgReserva" class="hidden text-sm font-bold text-red-600 bg-red-50 border border-red-100 rounded-xl px-4 py-3"></p>

        <div id="panelReservaUnica" class="hidden bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
            <div class="flex items-center justify-end mb-4">
                <button type="button" onclick="cerrarFormularioUnico()"
                    class="h-9 px-4 rounded-xl bg-slate-100 text-slate-600 font-bold text-xs hover:bg-slate-200 transition">
                    CERRAR
                </button>
            </div>

            <div class="space-y-6">
                {% for tour, salidas in tours_reserva_directa.items %}
                <div id="form-unico-tour-{{ tour.id }}" class="hidden formulario-unico-item bg-slate-50 rounded-3xl border border-slate-100 p-6">
                    <div class="flex flex-col lg:flex-row lg:items-start gap-6">
                        <div class="flex-1">
                            <h3 class="text-2xl font-black text-slate-900">{{ tour.nombre }}</h3>
                            <p class="text-sm text-slate-500 mt-2">{{ tour.descripcion|truncatechars:180 }}</p>
                            <p class="text-sm mt-4 font-bold text-slate-700">
                                Adulto: ${{ tour.precio_adulto_final|floatformat:2 }} - Nino: ${{ tour.precio_nino_final|floatformat:2 }}
                            </p>
                            <div class="mt-4">
                                <span class="inline-flex px-3 py-1 rounded-full bg-white text-slate-700 text-xs font-bold border border-slate-200 horario-seleccionado-label">
                                    --
                                </span>
                            </div>
                        </div>

                        <div class="lg:w-[420px]">
                            <form method="post" class="js-secretaria-form space-y-3 bg-white rounded-2xl p-4 border border-slate-100"
                                data-precio-adulto="{{ tour.precio_adulto_final|floatformat:2 }}">
                                {% csrf_token %}
                                <div>
                                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em] mb-2">Horario</label>
                                    <select name="salida_id" required class="js-select-horario w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                        {% for salida in salidas %}
                                        <option value="{{ salida.id }}" data-horario-label="{{ salida.fecha|date:'d/m/Y' }} {% if salida.hora %}{{ salida.hora|time:'h:i A' }}{% else %}Sin hora{% endif %} - {{ salida.cupos_disponibles }} cupos">{% if salida.hora %}{{ salida.hora|time:"h:i A" }}{% else %}Sin hora{% endif %} ({{ salida.cupos_disponibles }} cupos)</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em] mb-2">Adultos</label>
                                        <input type="number" min="0" name="adultos" value="1" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em] mb-2">Ninos</label>
                                        <input type="number" min="0" name="ninos" value="0" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                    </div>
                                </div>
                                <p class="text-[11px] font-bold text-slate-500 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                                    Tarifa ni√±os por edad: 0-2 = $10.00 | 3-5 = $35.00 | 6+ = $70.00
                                </p>
                                <div class="edades-ninos-wrap hidden space-y-2">
                                    <label class="block text-[10px] font-black uppercase text-slate-400 tracking-[0.15em]">Edades de los ninos</label>
                                    <div class="edades-ninos-list space-y-2"></div>
                                </div>
                                <div class="rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2">
                                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-700">Total a cobrar</p>
                                    <p class="text-2xl font-black text-emerald-700">$<span class="total-cobrar">0.00</span></p>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="text" name="nombre" placeholder="Nombre" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                    <input type="text" name="apellidos" placeholder="Apellidos" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="email" name="correo" placeholder="Correo" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                    <input type="tel" name="telefono" placeholder="Telefono" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                </div>
                                <input type="text" name="identificacion" placeholder="Cedula o pasaporte" required class="w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold">
                                <button type="submit"
                                    class="w-full h-11 bg-emerald-600 text-white rounded-xl font-black text-xs tracking-widest hover:bg-emerald-700 transition">
                                    CREAR RESERVA
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if destino_seleccionado %}
        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
            <h2 class="text-xl font-black text-slate-900">Resultados para {{ destino_seleccionado.nombre }}</h2>
            <p class="text-sm text-slate-500">Fecha: {{ fecha_busqueda }}</p>
        </div>
        {% endif %}

        <div class="space-y-6">
            {% for tour, salidas in tours_con_salidas.items %}
            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
                <h3 class="text-2xl font-black text-slate-900">{{ tour.nombre }}</h3>
                <p class="text-sm text-slate-500 mt-2">{{ tour.descripcion|truncatechars:180 }}</p>
                <p class="text-sm mt-4 font-bold text-slate-700">
                    Adulto: ${{ tour.precio_adulto_final|floatformat:2 }} - Nino: ${{ tour.precio_nino_final|floatformat:2 }}
                </p>
                <div class="mt-4 flex flex-wrap gap-2">
                    {% for salida in salidas %}
                    <span class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 text-xs font-bold">
                        {{ salida.fecha|date:"d/m/Y" }} {% if salida.hora %}{{ salida.hora|time:"h:i A" }}{% endif %} - {{ salida.cupos_disponibles }} cupos
                    </span>
                    {% endfor %}
                </div>
                <button type="button"
                    onclick="irAReservaTour('{{ tour.id }}')"
                    class="mt-5 h-10 px-6 rounded-xl bg-slate-900 text-white font-black text-[11px] tracking-widest hover:bg-primary transition">
                    IR A RESERVAR
                </button>
            </div>
            {% empty %}
            {% if destino_seleccionado %}
            <div class="bg-white rounded-3xl border border-dashed border-slate-200 p-10 text-center">
                <p class="text-slate-500 font-medium">No hay tours disponibles para esta busqueda.</p>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        {% if not destino_seleccionado %}
        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6">
            <div class="flex items-center justify-between gap-3 mb-5">
                <h2 class="text-xl font-black text-slate-900">Todos los tours</h2>
                <span class="text-xs font-black uppercase tracking-[0.15em] text-slate-400">{{ todos_los_tours|length }} registrados</span>
            </div>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for tour in todos_los_tours %}
                <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
                    <p class="text-xs font-black uppercase tracking-[0.15em] text-slate-400">{{ tour.destino.nombre }}</p>
                    <h3 class="text-lg font-black text-slate-900 mt-1">{{ tour.nombre }}</h3>
                    <p class="text-xs text-slate-500 mt-2">{{ tour.descripcion|truncatechars:110 }}</p>
                    <p class="text-sm mt-3 font-bold text-slate-700">
                        Adulto: ${{ tour.precio_adulto_final|floatformat:2 }} - Nino: ${{ tour.precio_nino_final|floatformat:2 }}
                    </p>
                    <button type="button"
                        onclick="irAReservaTour('{{ tour.id }}')"
                        class="mt-4 w-full h-10 rounded-xl bg-slate-900 text-white font-black text-[11px] tracking-widest hover:bg-primary transition">
                        IR A RESERVAR
                    </button>
                </div>
                {% empty %}
                <div class="sm:col-span-2 lg:col-span-3 rounded-2xl border border-dashed border-slate-200 p-6 text-center">
                    <p class="text-slate-500 font-medium">No hay tours creados todavia.</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const CHILD_PRICE_0_2 = parseFloat("{{ child_price_0_2|default:'10.00' }}");
    const CHILD_PRICE_3_5 = parseFloat("{{ child_price_3_5|default:'35.00' }}");
    const CHILD_PRICE_6_PLUS = parseFloat("{{ child_price_normal|default:'70.00' }}");

    function precioNinoPorEdad(edad) {
        if (isNaN(edad) || edad < 0) return 0;
        if (edad <= 2) return CHILD_PRICE_0_2;
        if (edad <= 5) return CHILD_PRICE_3_5;
        return CHILD_PRICE_6_PLUS;
    }

    function actualizarTotalFormulario(form) {
        const adultos = Math.max(parseInt(form.querySelector('input[name="adultos"]')?.value) || 0, 0);
        const precioAdulto = parseFloat(form.getAttribute('data-precio-adulto')) || 0;
        const edades = Array.from(form.querySelectorAll('input[name="edades_ninos"]')).map(i => parseInt(i.value));
        const totalNinos = edades.reduce((acc, edad) => acc + precioNinoPorEdad(edad), 0);
        const total = (adultos * precioAdulto) + totalNinos;
        const output = form.querySelector('.total-cobrar');
        if (output) output.innerText = total.toFixed(2);
    }

    function syncEdadesNinos(form) {
        const ninosInput = form.querySelector('input[name="ninos"]');
        const wrap = form.querySelector('.edades-ninos-wrap');
        const list = form.querySelector('.edades-ninos-list');
        if (!ninosInput || !wrap || !list) return;

        const totalNinos = Math.max(parseInt(ninosInput.value) || 0, 0);
        const actuales = Array.from(list.querySelectorAll('input[name="edades_ninos"]')).map(input => input.value);

        if (totalNinos === 0) {
            wrap.classList.add('hidden');
            list.innerHTML = '';
            actualizarTotalFormulario(form);
            return;
        }

        wrap.classList.remove('hidden');
        list.innerHTML = '';
        for (let i = 0; i < totalNinos; i++) {
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.step = '1';
            input.name = 'edades_ninos';
            input.required = true;
            input.placeholder = `Edad nino ${i + 1}`;
            input.className = 'w-full bg-white border border-slate-200 rounded-xl p-3 font-semibold';
            input.value = actuales[i] || '';
            input.addEventListener('input', () => actualizarTotalFormulario(form));
            list.appendChild(input);
        }
        actualizarTotalFormulario(form);
    }

    function inicializarFormulariosSecretaria() {
        document.querySelectorAll('.js-secretaria-form').forEach(form => {
            const ninosInput = form.querySelector('input[name="ninos"]');
            const adultosInput = form.querySelector('input[name="adultos"]');
            const selectHorario = form.querySelector('.js-select-horario');
            const labelHorario = form.closest('.formulario-unico-item')?.querySelector('.horario-seleccionado-label');
            if (!ninosInput || !adultosInput) return;

            const pintarHorarioSeleccionado = () => {
                if (!selectHorario || !labelHorario) return;
                const opt = selectHorario.options[selectHorario.selectedIndex];
                labelHorario.innerText = opt?.getAttribute('data-horario-label') || '--';
            };

            ninosInput.addEventListener('input', () => syncEdadesNinos(form));
            adultosInput.addEventListener('input', () => actualizarTotalFormulario(form));
            if (selectHorario) selectHorario.addEventListener('change', pintarHorarioSeleccionado);
            syncEdadesNinos(form);
            actualizarTotalFormulario(form);
            pintarHorarioSeleccionado();
        });
    }

    function irAReservaTour(tourId) {
        const msg = document.getElementById('msgReserva');
        if (msg) msg.classList.add('hidden');

        const panel = document.getElementById('panelReservaUnica');
        const items = document.querySelectorAll('.formulario-unico-item');
        items.forEach(item => item.classList.add('hidden'));

        const formTour = document.getElementById(`form-unico-tour-${tourId}`);
        if (!formTour) {
            if (msg) {
                msg.innerText = 'Este tour no tiene salidas disponibles para reservar en este momento.';
                msg.classList.remove('hidden');
            }
            return;
        }

        panel.classList.remove('hidden');
        formTour.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

        formTour.classList.add('ring-2', 'ring-primary', 'ring-offset-2');
        setTimeout(() => {
            formTour.classList.remove('ring-2', 'ring-primary', 'ring-offset-2');
        }, 1200);

        const inputNombre = formTour.querySelector('input[name="nombre"]');
        if (inputNombre) inputNombre.focus();
    }

    function cerrarFormularioUnico() {
        const panel = document.getElementById('panelReservaUnica');
        const items = document.querySelectorAll('.formulario-unico-item');
        items.forEach(item => item.classList.add('hidden'));
        panel.classList.add('hidden');
        const msg = document.getElementById('msgReserva');
        if (msg) msg.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', inicializarFormulariosSecretaria);
</script>
{% endblock %}
